# Plebeian Market - Staging
#
# Services:
#   staging.plebeian.market       → Market app (port 3000)
#   relay.staging.plebeian.market → Nostr relay (port 10547)
#   bugs.plebeian.market          → Bug tracker (port 10548)

staging.plebeian.market {
	root * /home/deployer/market-staging/dist
	encode gzip

	# API routes → Bun
	handle /api/* {
		reverse_proxy localhost:3000
	}

	# WebSocket → Bun
	@ws header Connection *Upgrade*
	handle @ws {
		reverse_proxy localhost:3000
	}

	# Static files with SPA fallback (must be last)
	handle {
		try_files {path} /index.html
		file_server
	}
}

relay.staging.plebeian.market {
	reverse_proxy localhost:10547
}

bugs.plebeian.market {
	reverse_proxy localhost:10548
}
