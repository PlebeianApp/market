name: E2E Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.22'

      - name: Install nak
        run: |
          go install github.com/fiatjaf/nak@latest
          echo "nak installed at: $(which nak)"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate routes
        run: bun run generate-routes

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium

      - name: Start relay
        run: |
          nohup nak serve --hostname 0.0.0.0 > /tmp/relay.log 2>&1 &
          echo "Waiting for relay on port 10547..."
          for i in $(seq 1 10); do
            if nc -z localhost 10547 2>/dev/null; then
              echo "Relay is ready"
              exit 0
            fi
            sleep 1
          done
          echo "::error::Relay failed to start. Logs:"
          cat /tmp/relay.log
          exit 1

      - name: Seed relay and start dev server
        run: |
          bun e2e-new/seed-relay.ts
          nohup bun dev > /tmp/devserver.log 2>&1 &
          echo "Waiting for dev server on port 3333..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:3333/api/config > /dev/null 2>&1; then
              echo "Dev server is ready"
              exit 0
            fi
            sleep 1
          done
          echo "::error::Dev server failed to start. Logs:"
          cat /tmp/devserver.log
          exit 1
        env:
          NODE_ENV: test
          PORT: '3333'
          APP_RELAY_URL: ws://localhost:10547
          APP_PRIVATE_KEY: e2e0000000000000000000000000000000000000000000000000000000000001
          LOCAL_RELAY_ONLY: 'true'

      - name: Run e2e tests
        run: bun test:e2e-new

      - name: Show server logs on failure
        if: failure()
        run: |
          echo "=== Relay logs ==="
          cat /tmp/relay.log 2>/dev/null || echo "(no relay log)"
          echo ""
          echo "=== Dev server logs ==="
          cat /tmp/devserver.log 2>/dev/null || echo "(no dev server log)"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: test-results
          path: test-results/
          retention-days: 7
