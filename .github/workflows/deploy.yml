name: Deploy to Staging

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  BUN_VERSION: 'latest'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      release_name: ${{ steps.release.outputs.name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build application
        run: |
          bun run generate-routes
          bun run build

      - name: Generate release name
        id: release
        run: echo "name=market-staging-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          cp -r dist deploy-package/
          cp -r src deploy-package/
          cp package.json bun.lock tsconfig.json deploy-package/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy-package/
          retention-days: 1

  deploy-staging:
    name: Deploy to Staging
    needs: build
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-package
          path: deploy-package/

      - name: Create ecosystem config
        run: |
          cat > deploy-package/ecosystem.config.cjs << 'EOF'
          module.exports = {
            apps: [{
              name: 'market-staging',
              script: 'src/index.tsx',
              interpreter: process.env.HOME + '/.bun/bin/bun',
              cwd: '/home/deployer/market-staging',
              instances: 1,
              exec_mode: 'fork',
              env_file: '.env',
              error_file: '/home/deployer/logs/market-staging-error.log',
              out_file: '/home/deployer/logs/market-staging-out.log',
              log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
              merge_logs: true,
              autorestart: true,
              max_restarts: 10,
              min_uptime: '10s',
              restart_delay: 5000,
              max_memory_restart: '500M',
              kill_timeout: 5000,
              wait_ready: true,
              listen_timeout: 10000,
            }],
          };
          EOF

      - name: Create environment file
        run: |
          cat > deploy-package/.env << EOF
          NODE_ENV=production
          PORT=3000
          APP_RELAY_URL=${{ secrets.STAGING_RELAY_URL }}
          APP_PRIVATE_KEY=${{ secrets.STAGING_APP_PRIVATE_KEY }}
          NIP46_RELAY_URL=wss://relay.nsec.app
          EOF

      - name: Create releases directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          password: ${{ secrets.STAGING_PASSWORD }}
          script: |
            mkdir -p ~/releases ~/logs
            mkdir -p ~/releases/${{ needs.build.outputs.release_name }}
            chmod 755 ~

      - name: Deploy files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          password: ${{ secrets.STAGING_PASSWORD }}
          source: 'deploy-package/*'
          target: '/home/deployer/releases/${{ needs.build.outputs.release_name }}'
          strip_components: 1
          overwrite: true

      - name: Deploy Caddyfile
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          password: ${{ secrets.STAGING_PASSWORD }}
          source: 'deploy-simple/caddyfiles/Caddyfile.staging'
          target: '/tmp'
          strip_components: 2

      - name: Activate release
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          password: ${{ secrets.STAGING_PASSWORD }}
          script: |
            set -e
            RELEASE_DIR="/home/deployer/releases/${{ needs.build.outputs.release_name }}"
            APP_DIR="/home/deployer/market-staging"

            # Install dependencies
            cd "$RELEASE_DIR"
            export PATH="$HOME/.bun/bin:$PATH"
            bun install --production

            # Stop current version
            pm2 stop market-staging 2>/dev/null || true

            # Swap symlink (blue-green)
            ln -sfn "$RELEASE_DIR" "$APP_DIR"

            # Start new version with PM2
            cd "$APP_DIR"
            pm2 startOrReload ecosystem.config.cjs --only market-staging
            pm2 save --force

            # Update Caddy
            sudo cp /tmp/Caddyfile.staging /etc/caddy/Caddyfile
            sudo mkdir -p /var/log/caddy
            sudo caddy reload --config /etc/caddy/Caddyfile --adapter caddyfile || \
              sudo caddy start --config /etc/caddy/Caddyfile --adapter caddyfile

            # Cleanup old releases (keep last 3)
            cd /home/deployer/releases
            ls -t | grep '^market-staging' | tail -n +4 | xargs -r rm -rf

            echo "✅ Staging deployment complete"

      - name: Health check
        run: |
          sleep 10
          curl -sf https://staging.plebeian.market/api/config
          echo "✅ Health check passed"
